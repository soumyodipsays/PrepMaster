@model PrepMaster.Models.TeacherOnboardingVM

@{
    ViewBag.Title = "Teacher Onboarding";
}

<h2>Assign Subjects to Teacher</h2>

<hr />

<div id="messageBox" class="mb-3"></div>

<input type="hidden" id="teacherId" value="@Model.TeacherId" />

@{
    var groupedData = Model.AvailableSubjects
                            .GroupBy(x => new { x.ClassId, x.ClassName })
                            .OrderBy(g => g.Key.ClassName);
}

@foreach (var classGroup in groupedData)
{
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <strong>@classGroup.Key.ClassName</strong>
        </div>
        <div class="card-body">
            @foreach (var subject in classGroup)
            {
                <div class="form-check">
                    <input class="form-check-input subject-checkbox"
                           type="checkbox"
                           value="@subject.MatchId"
                           id="match_@subject.MatchId" />

                    <label class="form-check-label" for="match_@subject.MatchId">
                        @subject.SubjectName
                    </label>
                </div>
            }
        </div>
    </div>
}

<button id="btnSave" class="btn btn-success">
    Save Specializations
</button>

@section scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $("#btnSave").click(function () {

            var teacherId = $("#teacherId").val();
            var selectedIds = [];

            $(".subject-checkbox:checked").each(function () {
                selectedIds.push($(this).val());
            });

            if (selectedIds.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Selection',
                    text: 'Please select at least one subject.',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            $.ajax({
                url: '@Url.Action("AddSpecialization", "Teacher")',
                type: 'POST',
                data: {
                    TeacherId: teacherId,
                    MatchIdList: selectedIds.join(",")
                },
                beforeSend: function () {
                    $("#btnSave").prop("disabled", true);
                },
                success: function (response) {

                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Success',
                            text: response.message,
                            confirmButtonColor: '#28a745'
                        });

                        $(".subject-checkbox").prop("checked", false);
                    }
                    else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message,
                            confirmButtonColor: '#dc3545'
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Server Error',
                        text: 'Something went wrong. Please try again.',
                        confirmButtonColor: '#dc3545'
                    });
                },
                complete: function () {
                    $("#btnSave").prop("disabled", false);
                }
            });

        });
    </script>
}